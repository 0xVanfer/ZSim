
# ZSim APL设计书

本文档概述了编写动作优先级列表（APL）脚本的规则和语法。

> APL是什么：
>
> APL（Action Priority List） 是 SimulationCraft 中一个核心功能，用于定义角色在模拟战斗中执行技能的优先级顺序。

ZSim 的APL也正是仿照Simc的APL运行逻辑写的。但是在具体的运行上有一些不同。

## **0.ZSim中的APL设计规则**

- **前提：**由于ZZZ的手法是根据队伍来定制的，所以，APL的最优解也一定是根据队伍来写的——即：**一套队伍，一套手法**是当前版本的理想情况。

  但是，这样的维护性会非常差，工作量很大。

- **限制：**从维护成本的角度来说，分层决策才是最好的（表层决策只写到“当前应该由强攻角色站场”这一层级即可），但是这样会使整个脚本的逻辑更加复杂， 因为需要考虑到不同角色相互更换、串联的情况。但是这里是整个程序的最终构想，期待一个看见解决这个需求的代码解决。

---

## 1. 基本规则

1. **动作优先级**：APL 脚本从上到下逐行解析动作，并执行第一个满足条件的动作。
2. **条件判断**：条件是动作执行的核心，通常基于角色和敌人的状态（如资源、冷却时间、敌人状态等）。
3. **注释**：使用 `#` 开头的行作为注释，不会被解析器执行。

---

## 2. APL 的语法结构

APL 脚本的每一行代码表示一个动作及其触发条件，通用结构如下：

```
CID|actions+=|action_name|condition1|condition2|...
```

### 关键要素

- **`CID`**：角色的数字ID，唯一，一般为四位数。
- **`actions+=`**：动作列表的前缀，表示将动作添加到当前优先级列表中。
- **`action_name`**：技能的唯一ID 或是技能的**`TriggerBuffLevel`**（后者通常用于默认设置），表示角色执行的动作。
- **`condition`**（可选）：触发动作的条件，多个条件使用 `|` 分隔。

---

## 3. 关键字和条件

### 动作关键字

- **`auto_attack`**：执行基础自动攻击。当系统检测到action的内容是auto_attack时，会自动前往`character_NA_chain.json`调取对应的dict出来，并且按照读取当前的`action_stack`，找出当前动作和上一个动作，以上一个动作为键值来调出对应的值，就实现了普攻循环。
- **`skill_name`**：执行指定技能。

### 条件关键字

#### 与资源相关：
- `energy>=N`：检查角色的能量值是否大于或等于 `N`。
- `special_resource<N`：检查角色的特殊资源是否小于 `N`。

#### 与Buff持续时间相关***（格式应该还要改）***：
- `buff_index.active=True`：检查`dynamic_buff_dict`中是否存在对应的Buff(可能涉及到循环，性能问题待优化)
- `buff_index.dy.count<N`：检查Buff的当前层数是否小于 `N` 。

#### 与敌人状态相关：
- `enemy.health.pct<N`：检查目标的生命值百分比是否小于 `N`。
- `enemy.time_to_die>N`：检查目标预计存活时间是否大于 `N` 帧。
- `enemy.dynamic.frozen=True`：检查目标当前是否处于冻结状态。

#### 与时间相关：
- `time<N`：检查战斗持续时间是否小于 `N` 秒。
- `time>=N`：检查战斗持续时间是否大于或等于 `N` 秒。

#### 与上一个技能相关：

- **`last_action=skill_tag`**：检查上一个技能的情况。

---

## 4. 书写规范

### 1. 基本格式规范
- 每行仅定义一个动作及其条件，便于阅读和解析。
- 动作和条件用 `|` 分隔，条件之间没有额外的空格。
- 条件的优先级顺序尽量从简单到复杂（例如冷却 > 资源 > 角色状态）。

### 2. 注释规范
- 使用 `#` 进行注释，说明动作的目的或触发条件。
- 注释可以位于动作行后，也可以单独占一行。

```apl
# 角色的默认攻击动作
actions+=|auto_attack
```

### 3. 条件表达式规范
- 条件复杂时，用 `|` 将逻辑拆分成多个小块，便于维护。
- 逻辑语句尽量简洁，避免冗长的嵌套。

```apl
actions+=|skill_name|if=energy>=50|cooldown.skill_name.ready
```

---

## 5. 示例

以下是完整的 APL 代码示例：

```apl
# 自动攻击，适用于所有角色
actions+=|auto_attack

# 使用饰品，当饰品冷却完成时
actions+=|use_item,name=trinket1|if=cooldown.trinket1.ready

# 主要技能，当能量 >= 50 且技能无冷却时使用
actions+=|primary_attack|if=energy>=50|cooldown.primary_attack.ready

# 增强技能，当增益 Buff 激活时触发
actions+=|empower_skill|if=buff.empowered.up

# 次要技能，用于填充能量不足时的空档期
actions+=|secondary_attack|if=energy<50
```

---

## 6. 常见错误与检查

### 错误类型
1. **条件书写错误**：
   - 漏写条件分隔符 `|` 或关键字拼写错误。
   - 示例：`ifenergy>=50` 应为 `if=energy>=50`。

2. **语法不一致**：
   - 动作和条件之间的格式不统一。

3. **优先级冲突**：
   - 高优先级动作未覆盖，导致低优先级动作无机会执行。

---

## 7. 调试与优化

1. **日志调试**：实现日志系统，记录每次执行的动作及未满足的条件。
2. **模拟战斗测试**：运行 APL 脚本模拟多种战斗场景，验证逻辑是否正确。
3. **条件优化**：调整复杂条件的顺序，提升解析效率。
